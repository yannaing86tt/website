{% extends "panel/base.html" %}
{% block title %}{% if mode == "create" %}New Post{% else %}Edit Post{% endif %}{% endblock %}

{% block content %}
  <h2 style="margin-top:0;">{% if mode == "create" %}New Post{% else %}Edit Post{% endif %}</h2>

  {% if error %}
  <div style="padding:10px; background:#ffecec; border:1px solid #ffb3b3; margin:12px 0; border-radius:10px;">
    {{ error }}
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" style="display:grid; gap:14px;">
    {% csrf_token %}

    <div>
      <label style="display:block; margin-bottom:6px;">Title</label>
      <input name="title" value="{% if post %}{{ post.title }}{% endif %}"
             style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
    </div>

    <div>
      <label style="display:block; margin-bottom:6px;">Slug (optional)</label>
      <input name="slug" value="{% if post %}{{ post.slug }}{% endif %}"
             placeholder="auto-generate if empty"
             style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
      <div style="font-size:12px; opacity:.75; margin-top:6px; margin-bottom:14px; line-height:1.6;">
        ·Äô·Äº·Äî·Ä∫·Äô·Ä¨·ÄÖ·Ä¨/space ·Äï·Ä´·Äú·Ää·Ä∫·Ä∏ OK (link ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫·Äû·ÄØ·Ä∂·Ä∏·Äô·Äö·Ä∫)
      </div>
    </div>

    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <div>
        <label style="display:block; margin-bottom:6px;">Status</label>
        <select name="status" style="padding:10px; border-radius:10px; border:1px solid #ddd;">
          <option value="draft" {% if post and post.status == "draft" %}selected{% endif %}>Draft</option>
          <option value="published" {% if post and post.status == "published" %}selected{% endif %}>Published</option>
        </select>
      </div>

      <div style="flex:1; min-width:260px;">
        <label style="display:block; margin-bottom:6px;">Video URL (YouTube/Vimeo)</label>
        <input name="video_url" value="{% if post %}{{ post.video_url }}{% endif %}"
               style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
      </div>
    </div>

    <div>
      <label style="display:block; margin-bottom:6px;">Cover Image</label>
      <input type="file" name="cover_image">
      {% if post and post.cover_image %}
        <div style="margin-top:8px; font-size:13px;">
          Current: <a href="{{ post.cover_image.url }}" target="_blank">{{ post.cover_image.url }}</a>
        </div>
      {% endif %}
    </div>

    <div>
      <label style="display:block; margin-bottom:6px;">Content (Markdown)</label>

      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1; min-width:320px;">
          <textarea id="mdInput" name="content" rows="16"
            style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">{% if post %}{{ post.content }}{% endif %}</textarea>
          <div style="font-size:12px; opacity:.75; margin-top:6px; line-height:1.5;">
            Tips: **bold**, _italic_, `code`, ```code block```, - list, # heading
          </div>
        </div>

        <div style="flex:1; min-width:320px;">
          <div id="mdPreviewContainer" style="padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: linear-gradient(135deg, rgba(15,20,35,.95), rgba(10,15,28,.95)); min-height: 420px; box-shadow: 0 8px 25px rgba(0,0,0,.35);">
            <div style="font-size:12px; color: rgba(232,238,252,.65); margin-bottom:14px; font-weight: 600;">üìÑ Preview</div>
            <div id="mdPreview" style="line-height:1.8; color: rgba(232,238,252,.92);"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <button style="padding:10px 14px; border-radius:10px; border:1px solid #ddd;">Save</button>
      <a href="/panel/posts/" style="align-self:center;">Cancel</a>
    </div>
  </form>

  <style>
    /* Dark theme preview styles */
    #mdPreview {
      font-family: 'Inter', 'Noto Sans Myanmar', system-ui, sans-serif;
    }
    
    #mdPreview h1,
    #mdPreview h2,
    #mdPreview h3,
    #mdPreview h4,
    #mdPreview h5,
    #mdPreview h6 {
      color: rgba(232, 238, 252, 0.95);
      font-weight: 800;
      margin: 1.5em 0 0.75em;
      line-height: 1.3;
      letter-spacing: -0.3px;
    }
    
    #mdPreview h1 { font-size: 2rem; border-bottom: 2px solid rgba(102,126,234,.3); padding-bottom: 0.4em; }
    #mdPreview h2 { font-size: 1.65rem; }
    #mdPreview h3 { font-size: 1.4rem; }
    #mdPreview h4 { font-size: 1.2rem; }
    
    #mdPreview p {
      color: rgba(232, 238, 252, 0.88);
      margin: 1em 0;
      line-height: 1.8;
    }
    
    #mdPreview a {
      color: #667eea;
      text-decoration: none;
      border-bottom: 1px solid rgba(102,126,234,.4);
    }
    
    #mdPreview a:hover {
      color: #764ba2;
      border-bottom-color: #764ba2;
    }
    
    #mdPreview code {
      background: rgba(0,0,0,.4);
      color: #a78bfa;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 0.9em;
      font-family: 'Monaco', 'Courier New', monospace;
    }
    
    #mdPreview pre {
      background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 16px;
      overflow-x: auto;
      margin: 1.5em 0;
    }
    
    #mdPreview pre code {
      background: none;
      padding: 0;
      color: rgba(232,238,252,.95);
    }
    
    #mdPreview blockquote {
      border-left: 4px solid #667eea;
      padding: 1em 1.5em;
      margin: 1.5em 0;
      background: rgba(102,126,234,.1);
      border-radius: 0 10px 10px 0;
      color: rgba(232,238,252,.9);
    }
    
    #mdPreview ul,
    #mdPreview ol {
      padding-left: 2em;
      margin: 1em 0;
      color: rgba(232,238,252,.88);
    }
    
    #mdPreview li {
      margin: 0.5em 0;
    }
    
    #mdPreview table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5em 0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    #mdPreview th,
    #mdPreview td {
      padding: 10px 14px;
      border: 1px solid rgba(255,255,255,.12);
      text-align: left;
    }
    
    #mdPreview th {
      background: rgba(102,126,234,.2);
      font-weight: 700;
      color: rgba(232,238,252,.95);
    }
    
    #mdPreview td {
      background: rgba(255,255,255,.04);
      color: rgba(232,238,252,.88);
    }
    
    #mdPreview img {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      margin: 1.5em 0;
    }
    
    #mdPreview hr {
      border: none;
      border-top: 1px solid rgba(255,255,255,.15);
      margin: 2em 0;
    }
  </style>

  <script>
  const input = document.getElementById("mdInput");
  const preview = document.getElementById("mdPreview");
  let t = null;

  async function renderPreview() {
    preview.innerHTML = "<div style='opacity:.6; font-style: italic;'>‚è≥ Rendering...</div>";

    const fd = new FormData();
    fd.append("text", input.value);

    let res;
    try {
      res = await fetch("/panel/md-preview/", {
        method: "POST",
        credentials: "same-origin",
        body: fd
      });
    } catch (e) {
      preview.innerHTML = "<div style='opacity:.6; color: #ff6b6b;'>‚ùå Preview error (network)</div>";
      return;
    }

    if (!res.ok) {
      preview.innerHTML = `<div style='opacity:.6; color: #ff6b6b;'>‚ùå Preview error (${res.status})</div>`;
      return;
    }

    const ct = (res.headers.get("content-type") || "").toLowerCase();
    if (!ct.includes("application/json")) {
      const txt = await res.text();
      preview.innerHTML = `<div style='opacity:.6; color: #ff6b6b;'>‚ùå Preview error (not json) ‚Äî maybe redirected to login</div>
      <pre style="white-space:pre-wrap; font-size:11px; opacity:.5; margin-top:8px; color: rgba(232,238,252,.6);">${txt.slice(0,300)}</pre>`;
      return;
    }

    const data = await res.json();
    preview.innerHTML = data.html || "<div style='opacity:.5; font-style: italic;'>Empty content</div>";

    if (window.decorateCodeBlocks) window.decorateCodeBlocks(preview);
  }

  function schedule() {
    clearTimeout(t);
    t = setTimeout(renderPreview, 250);
  }

  input.addEventListener("input", schedule);
  renderPreview();
</script>

{% endblock %}
